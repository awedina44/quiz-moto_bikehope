<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Quiz Moto</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    .screen { display: none; }
    .visible { display: block; }
    .badge { display: inline-block; background: gold; padding: 5px 10px; border-radius: 10px; margin: 5px; }
  </style>
</head>
<body>
  <h1>Quiz Moto</h1>

  <!-- Écran de connexion -->
  <div id="loginScreen" class="screen visible">
    <h2>Connexion</h2>
    <select id="existingProfile"></select><br><br>
    <input type="text" id="firstName" placeholder="Prénom">
    <input type="text" id="gamertag" placeholder="Gamertag">
    <button onclick="loginOrCreate()">Commencer</button>
  </div>

  <!-- Écran principal -->
  <div id="mainScreen" class="screen">
    <h2 id="welcomeMessage"></h2>
    <p id="stats"></p>
    <button onclick="startQuiz()">Lancer le quiz</button>
    <div id="badges"></div>
  </div>

  <!-- Écran du quiz -->
  <div id="quizScreen" class="screen">
    <h2 id="question"></h2>
    <div id="choices"></div>
  </div>

  <!-- Écran des résultats -->
  <div id="resultScreen" class="screen">
    <h2>Résultat</h2>
    <p id="result"></p>
    <button onclick="goToMain()">Retour</button>
  </div>

  <!-- Firebase SDK + Quiz Logic -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDQKrs5BTCg_KOkOg5Qhm1xDjk0O9-XzAA",
      authDomain: "quiz-moto-9aedd.firebaseapp.com",
      projectId: "quiz-moto-9aedd",
      storageBucket: "quiz-moto-9aedd.firebasestorage.app",
      messagingSenderId: "113444665192",
      appId: "1:113444665192:web:81afbddbf9062cdb0a08dd",
      measurementId: "G-VNH2D9FEDF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables
    let profiles = {};
    let currentUser = null;
    const questions = [
      { q: "Quelle moto est une Yamaha ?", options: ["CBR600", "YZF-R6", "Z750", "Panigale"], answer: 1 },
      { q: "Quel équipement est obligatoire ?", options: ["Casque", "Gants", "Gilet jaune", "Bottes"], answer: 0 }
    ];
    let currentQuestion = 0;
    let score = 0;

    // Fonctions d'affichage
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(div => div.classList.remove('visible'));
      document.getElementById(id).classList.add('visible');
    }

    // Chargement des profils depuis Firestore
    async function loadExistingProfiles() {
      const select = document.getElementById('existingProfile');
      select.innerHTML = '<option value="">-- Nouveau profil --</option>';
      profiles = {};
      const snapshot = await getDocs(collection(db, "profiles"));
      snapshot.forEach(docSnap => {
        const p = docSnap.data();
        profiles[p.id] = p;
        select.innerHTML += `<option value="${p.id}">${p.firstName} (${p.gamertag})</option>`;
      });
    }

    // Connexion ou création
    async function loginOrCreate() {
      const existingId = document.getElementById('existingProfile').value;
      const firstName = document.getElementById('firstName').value.trim();
      const gamertag = document.getElementById('gamertag').value.trim();

      if (existingId) {
        currentUser = profiles[existingId];
      } else if (firstName && gamertag) {
        const id = Date.now().toString();
        currentUser = {
          id, firstName, gamertag,
          totalScore: 0, bestScore: 0, gamesPlayed: 0,
          history: [], badges: []
        };
        profiles[id] = currentUser;
        await setDoc(doc(db, "profiles", id), currentUser);
      } else {
        alert("Remplis tous les champs ou choisis un profil.");
        return;
      }

      document.getElementById('welcomeMessage').textContent = `Bienvenue ${currentUser.firstName} !`;
      updateUserStats();
      showScreen('mainScreen');
    }

    // Statistiques utilisateur
    function updateUserStats() {
      document.getElementById('stats').textContent = `Parties: ${currentUser.gamesPlayed} | Score total: ${currentUser.totalScore} | Meilleur: ${currentUser.bestScore}`;
      document.getElementById('badges').innerHTML = currentUser.badges.map(b => `<span class="badge">${b}</span>`).join('');
    }

    // Démarrer le quiz
    function startQuiz() {
      score = 0;
      currentQuestion = 0;
      showScreen('quizScreen');
      showQuestion();
    }

    // Afficher une question
    function showQuestion() {
      const q = questions[currentQuestion];
      document.getElementById('question').textContent = q.q;
      const container = document.getElementById('choices');
      container.innerHTML = "";
      q.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.onclick = () => answerQuestion(i);
        container.appendChild(btn);
      });
    }

    // Répondre à une question
    async function answerQuestion(choice) {
      if (choice === questions[currentQuestion].answer) score += 1;
      currentQuestion += 1;
      if (currentQuestion < questions.length) {
        showQuestion();
      } else {
        await endQuiz();
      }
    }

    // Fin du quiz
    async function endQuiz() {
      const msg = `Score: ${score}/${questions.length}`;
      document.getElementById('result').textContent = msg;
      currentUser.totalScore += score;
      currentUser.gamesPlayed += 1;
      currentUser.bestScore = Math.max(currentUser.bestScore, score);
      currentUser.history.push({ date: new Date().toISOString(), score });

      // Gagner des badges
      if (score === questions.length && !currentUser.badges.includes("Parfait !")) {
        currentUser.badges.push("Parfait !");
      }

      await setDoc(doc(db, "profiles", currentUser.id), currentUser);
      updateUserStats();
      showScreen('resultScreen');
    }

    // Retour accueil
    function goToMain() {
      showScreen('mainScreen');
    }

    // Initialisation
    window.onload = loadExistingProfiles;
  </script>
</body>
</html>
